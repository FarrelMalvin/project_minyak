<!DOCTYPE html>
<html>
<head>
  <title>Produk</title>
  <script src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="SB-Mid-client-44JyAuImP_XPOzeZ"></script>
</head>
<body>
  <h2>Pilih Produk</h2>

  <!-- Info User -->
  <div id="user-info" style="margin-bottom: 20px; padding: 10px; border: 1px solid gray;">
    <strong>Info Pengguna:</strong><br>
    Nama: <span id="user-name">-</span><br>
    Email: <span id="user-email">-</span>
  </div>

  <!-- Form Produk -->
  <label>Produk:</label>
  <select id="product">
    <option value="Minyak Goreng" data-price="15000">Minyak Goreng - Rp15.000</option>
    <option value="Minyak Bumi" data-price="25000">Minyak Bumi - Rp25.000</option>
  </select><br><br>

  <label>Jumlah:</label>
  <input type="number" id="quantity" value="1" min="1"><br><br>

  <button onclick="checkout()">Bayar Sekarang</button>

  <script>
    // Tampilkan info user dari localStorage
    const customer_name = localStorage.getItem("customer_name");
    const customer_email = localStorage.getItem("customer_email");

    if (customer_name && customer_email) {
      document.getElementById("user-name").innerText = customer_name;
      document.getElementById("user-email").innerText = customer_email;
    } else {
      alert("Silakan login terlebih dahulu!");
      window.location.href = "test.html";
    }

    function checkout() {
      const product = document.getElementById("product");
      const price = parseInt(product.options[product.selectedIndex].getAttribute("data-price"));
      const quantity = parseInt(document.getElementById("quantity").value);
      const gross_amount = price * quantity;

      // Validasi ulang sebelum kirim ke backend
      if (!customer_name || !customer_email) {
        alert("Silakan login terlebih dahulu!");
        return;
      }

      fetch("http://localhost:9090/checkout", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    order_id: "ORDER-" + Date.now(),
    gross_amount: gross_amount,
    customer_name: customer_name,
    customer_email: customer_email
  })
})
.then(async res => {
  const text = await res.text();  // ambil response sebagai teks mentah
  console.log("Raw response:", text); // ini akan kasih tau kamu responsenya JSON valid atau HTML error
  return JSON.parse(text); // parse secara manual
})
.then(data => {
  console.log("Snap token:", data.token);
  window.snap.pay(data.token);
})
.catch(err => {
  console.error("Payment error:", err);
  alert("Gagal membuat transaksi. Cek console log.");
});

    }
  </script>
</body>
</html>
